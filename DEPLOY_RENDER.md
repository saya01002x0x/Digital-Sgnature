# Deploy to Render.com using render.yaml

## Prerequisites

1. **GitHub Repository**: Push your code to GitHub
2. **Render Account**: Sign up at https://render.com
3. **Supabase Database**: Already set up
4. **Cloudflare R2**: Already configured

## Deployment Steps

### 1. Push Code to GitHub

```bash
git add .
git commit -m "Add render.yaml for deployment"
git push origin main
```

### 2. Connect to Render

1. Go to https://dashboard.render.com
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub repository
4. Select the repository containing `render.yaml`
5. Render will auto-detect the `render.yaml` file

### 3. Configure Environment Variables

Render will prompt you to set these **sync: false** variables:

#### Database (Supabase)
- `SPRING_DATASOURCE_URL`: Your Supabase connection string
  ```
  jdbc:postgresql://aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres?user=postgres.xxxxx
  ```
- `SPRING_DATASOURCE_PASSWORD`: Your Supabase database password

#### Cloudflare R2
- `R2_ENDPOINT`: `https://<account-id>.r2.cloudflarestorage.com`
- `R2_ACCESS_KEY_ID`: Your R2 access key
- `R2_SECRET_ACCESS_KEY`: Your R2 secret key
- `R2_BUCKET_NAME`: `digital-signature-files`

> **Note**: `JWT_SECRET` and `CRYPTO_AES_KEY` will be auto-generated by Render

### 4. Deploy

1. Click **"Apply"** to create services
2. Render will:
   - Build Docker images for backend and frontend
   - Deploy both services
   - Set up health checks

### 5. Configure Service URLs (Important!)

After both services are deployed, you need to set the URLs manually:

1. **Get Backend URL**:
   - Go to `digital-signature-backend` service
   - Copy the URL (e.g., `https://digital-signature-backend.onrender.com`)

2. **Get Frontend URL**:
   - Go to `digital-signature-frontend` service  
   - Copy the URL (e.g., `https://digital-signature-frontend.onrender.com`)

3. **Update Backend Environment Variables**:
   - Go to `digital-signature-backend` → **Environment**
   - Set:
     - `CORS_ALLOWED_ORIGIN` = Frontend URL
     - `FRONTEND_URL` = Frontend URL
     - `APP_BASE_URL` = Backend URL
   - Click **Save Changes** (will trigger redeploy)

4. **Update Frontend Environment Variables**:
   - Go to `digital-signature-frontend` → **Environment**
   - Set:
     - `VITE_API_URL` = Backend URL
   - Click **Save Changes** (will trigger rebuild)

### 6. Verify Deployment

1. **Backend**: Check `https://digital-signature-backend.onrender.com/actuator/health`
2. **Frontend**: Visit `https://digital-signature-frontend.onrender.com`

## Important Notes

### Free Tier Limitations

- Services **spin down after 15 minutes** of inactivity
- First request after spin-down takes **~1 minute** to wake up
- Upgrade to **Starter plan ($7/month)** to keep services always on

### Custom Domains

To use custom domain:
1. Go to service → **Settings** → **Custom Domain**
2. Add your domain
3. Update DNS records as instructed

### Updating Deployment

When you push to `main` branch, Render will **auto-deploy** changes.

To manually redeploy:
1. Go to service → **Manual Deploy** → **Deploy latest commit**

## Troubleshooting

### Build Fails

Check **Logs** tab for errors. Common issues:
- Missing environment variables
- Docker build errors
- Port conflicts

### Database Connection Issues

Ensure Supabase allows connections from Render IPs:
- Supabase → **Settings** → **Database** → **Connection Pooling**
- Use **Transaction mode** for better performance

### R2 Access Issues

If you still see CORS errors:
1. Check R2 bucket CORS settings in Cloudflare dashboard
2. Verify `APP_BASE_URL` is set correctly
3. Check backend logs for R2 connection errors

## Cost Estimate

- **Free Tier**: $0/month (with spin-down)
- **Starter**: $14/month (2 services always on)
- **Database**: Supabase free tier
- **Storage**: R2 free tier (10GB)

**Total**: $0-14/month depending on uptime requirements
